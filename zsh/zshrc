#!/usr/bin/env zsh

export EDITOR=nvim
export TERM=xterm-256color
export LC_ALL=en_US.UTF-8
export LANG=en_US.UTF-8
export GOPATH=$HOME/go
export PATH=$PATH:$GOPATH/bin
export PATH="/usr/local/sbin:$HOME/.dotfiles/etc/bin:$PATH"
export PATH="/Applications/Postgres.app/Contents/Versions/9.6/bin:$PATH"
export ZSH_CACHE_DIR="${TMPDIR:-/tmp}"

# POWERLEVEL9K_LEFT_PROMPT_ELEMENTS=(user dir vcs rbenv rspec_stats newline)
# POWERLEVEL9K_RIGHT_PROMPT_ELEMENTS=(status root_indicator ip background_jobs history time)

# Prefer using emacs mode for zsh
bindkey -e

source ~/.zplugin/bin/zplugin.zsh

zplugin ice wait"0" lucid
zplugin light zsh-users/zsh-completions

zplugin ice wait"1" atload'_history_substring_search_bind_keys' lucid
zplugin light zsh-users/zsh-history-substring-search

zplugin light zdharma/history-search-multi-word

zplugin ice wait"!0" atload'_zsh_autosuggest_start' lucid
zplugin light zsh-users/zsh-autosuggestions

zplugin ice from"gh-r" as"program"
zplugin light junegunn/fzf-bin

PS1=$(dirs)$'\n'"‚ùØ "
# zplugin ice wait'0' lucid # This saves 20ms
# zplugin ice wait'0' atload"p9k_refresh_prompt_inplace" lucid reset-prompt # This does not work just yet
zplugin light romkatv/powerlevel10k

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ -f ~/.p10k.zsh ]] && source ~/.p10k.zsh

zplugin ice svn "rupa/z" pick"z.sh"; zplugin light "rupa/z"
zplugin snippet OMZ::lib/history.zsh

zplugin ice wait"1" as"completion" lucid
zplugin snippet https://github.com/docker/cli/blob/master/contrib/completion/zsh/_docker

zplugin ice wait"1" as"completion" lucid
zplugin snippet https://github.com/docker/compose/blob/master/contrib/completion/zsh/_docker-compose

# Load my zsh dotfiles, aliases
files=( {00_aliases,10_options,20_functions}.zsh )
zplugin ice multisrc"\$files" pick"/dev/null"
zplugin light %HOME/.dotfiles/zsh/config

zplugin ice wait"0" atinit"zpcompinit" lucid
zplugin light zdharma/fast-syntax-highlighting

# Note: Use wait 1 second works
zplugin ice svn wait"1" atload"zpcdreplay"
zplugin snippet OMZ::plugins/kubectl

# Compinit : After zplugins, before cdreplay
# https://carlosbecker.com/posts/speeding-up-zsh/
autoload -Uz compinit
if [ $(date +'%j') != $(stat -f '%Sm' -t '%j' ~/.zcompdump) ]; then
  compinit;
else
  compinit -C;
fi

zplugin cdreplay -q

# Key bindings for zsh-history-substring-search
_history_substring_search_bind_keys() {
  bindkey '^[[A' history-substring-search-up
  bindkey '^[[B' history-substring-search-down
  bindkey -M emacs '^P' history-substring-search-up
  bindkey -M emacs '^N' history-substring-search-down
  bindkey -M vicmd 'k' history-substring-search-up
  bindkey -M vicmd 'j' history-substring-search-down
}

if [ -d "$HOME/.asdf" ]; then
  zplugin ice wait"0" pick"asdf.sh" lucid
  zplugin light %HOME/.asdf

  zplugin ice wait"0" pick"asdf.bash" lucid
  zplugin light %HOME/.asdf/completions
fi

if [ -d "$HOME/.rbenv" ]; then
  eval "$(rbenv init - --no-rehash)"
fi

if [ -d "$HOME/.jenv" ]; then
  eval "$(jenv init -)"
fi

# Timing App Terminal Support
if [ $ITERM_SESSION_ID ]; then
  DISABLE_AUTO_TITLE="true"
  echo -ne "\033]0; ${USER} @ ${HOST%%.*} : ${PWD/# $HOME/ ~} \007"
fi

precmd() {
  echo -ne "\033]0; ${USER} @ ${HOST%%.*} : ${PWD/# $HOME/ ~} \007"
}

if [ -f "$HOME/.zshrc.local" ]; then
  source "$HOME/.zshrc.local"
fi

if [ -f ~/.bashhub/bashhub.zsh ]; then
  zplugin ice wait"0" pick".bashhub/bashhub.zsh" lucid
  zplugin light %HOME
fi
